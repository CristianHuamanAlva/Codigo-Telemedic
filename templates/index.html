<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Telemedic | Asistente Virtual</title>

  <!-- Bootstrap y Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/index.css">

</head>

<body>
  {% if current_user.is_authenticated %}
  <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
    <span class="navbar-brand">Telemedic</span>
    <div class="user-info d-flex align-items-center gap-2 position-relative">
      <span class="user-welcome">Bienvenido, {{ current_user.nombre }}</span>
      <div class="dropdown">
        <button class="btn btn-icon dropdown-toggle p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle fs-4 text-white"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end custom-dropdown">
          <li><a class="dropdown-item logout-item" href="/logout">Cerrar sesi√≥n</a></li>
        </ul>
      </div>
    </div>
  </nav>
  {% else %}
  <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
    <span class="navbar-brand">Telemedic</span>
    <a href="/login" class="btn btn-light fw-semibold">Iniciar sesi√≥n</a>
  </nav>
  {% endif %}

  <div class="chat-container d-flex flex-column">
    <div id="chat" class="p-3 d-flex flex-column"></div>
  </div>
  <footer class="custom-footer text-center text-white py-3 mt-5">
    <div class="container">
      <p class="mb-1">¬© 2025 <strong>Telemedic</strong>. Todos los derechos reservados.</p>
      <p class="mb-1">Elaborado por <strong>Grupo 5</strong> ‚Äì Estudiantes del curso de <em>Dise√±o de Productos y
          Servicios</em>.</p>
      <p class="mb-0">Versi√≥n 1.0 | Asistente virtual para orientaci√≥n m√©dica accesible</p>
    </div>
  </footer>

  <script>
    const userName = "{{ current_user.nombre }}";
    const chatContainer = document.getElementById('chat');

    let currentStep = 'start';
    let lastUserAnswer = null;

    const iconMap = {
      'S√≠ntomas generales': 'bi-thermometer-half',
      'Cuidado de medicamentos': 'bi-capsule',
      'Prevenci√≥n': 'bi-shield-check',
      'Emergencias': 'bi-exclamation-triangle',
      'Dolor de cabeza': 'bi-emoji-dizzy',
      'Fiebre': 'bi-thermometer-sun',
      'Tos': 'bi-wind',
      'Malestar general': 'bi-emoji-neutral',
    };
    const videoMap = {
      // S√≠ntomas generales
      'Dolor de cabeza': 'https://www.w3schools.com/html/mov_bbb.mp4',// 'videos/dolor_cabeza.mp4',
      'Fiebre': 'https://samplelib.com/lib/preview/mp4/sample-5s.mp4',
      'Tos': 'https://samplelib.com/lib/preview/mp4/sample-10s.mp4',
      'Malestar general': 'https://samplelib.com/lib/preview/mp4/sample-15s.mp4',

      // Cuidado de medicamentos
      '¬øC√≥mo debo tomar mi pastilla?': 'https://samplelib.com/lib/preview/mp4/sample-20s.mp4',
      '¬øQu√© hago si olvid√© una dosis?': 'https://samplelib.com/lib/preview/mp4/sample-30s.mp4',
      '¬øPuedo tomar 2 pastillas juntas?': 'https://samplelib.com/lib/preview/mp4/sample-40s.mp4',
      '¬øQu√© medicamentos no debo mezclar?': 'https://samplelib.com/lib/preview/mp4/sample-50s.mp4',

      // Prevenci√≥n
      '¬øC√≥mo puedo evitar un resfriado?': 'https://samplelib.com/lib/preview/mp4/sample-1mb.mp4',
      '¬øQu√© hago para cuidar mi salud todos los d√≠as?': '/static/videos/prevenir.mp4',
      '¬øPor qu√© es importante lavarse las manos?': 'https://samplelib.com/lib/preview/mp4/sample-3mb.mp4',
      '¬øDebo vacunarme?': '/static/videos/vacuna.mp4',

      // Emergencias
      '¬øQu√© hago si alguien se desmaya?': 'https://samplelib.com/lib/preview/mp4/sample-5mb.mp4',
      '¬øC√≥mo actuar ante una convulsi√≥n?': 'https://samplelib.com/lib/preview/mp4/sample-7mb.mp4',
      '¬øQu√© hacer si hay dificultad para respirar?': 'https://samplelib.com/lib/preview/mp4/sample-9mb.mp4',
      '¬øCu√°ndo debo ir a emergencias?': 'https://samplelib.com/lib/preview/mp4/sample-10mb.mp4'
    };



    const steps = {
      start: () => {
        addMessage(`¬°Hola ${userName}! Soy Telemedic, tu asistente virtual para orientaci√≥n m√©dica accesibleüßë‚Äç‚öïü§ù ¬øEst√°s listo para comenzar?`, 'bot', () => {
          nextStep('consultas');
        });
      },
      consultas: () => {
        addMessage('¬øEn qu√© tema de salud deseas recibir orientaci√≥n hoy?', 'bot', () => {
          showOptions(['Elegir de una lista', 'Escribir mi duda'], (respuesta) => {
            if (respuesta === 'Elegir de una lista') {
              showOptions(['S√≠ntomas generales', 'Cuidado de medicamentos', 'Prevenci√≥n', 'Emergencias'], (tema) => {
                lastUserAnswer = tema;
                if (tema === 'S√≠ntomas generales') nextStep('sintomas');
                else if (tema === 'Cuidado de medicamentos') nextStep('medicamentos');
                else if (tema === 'Prevenci√≥n') nextStep('prevencion');
                else if (tema === 'Emergencias') nextStep('emergencias');
              });
            } else {
              nextStep('entradaLibre');
            }
          });
        });
      },
      entradaLibre: () => {
        addMessage('Escribe tu duda m√©dica y te responder√© en Lengua de Se√±as Peruana:', 'bot', () => {
          showInputText((textoIngresado) => {
            lastUserAnswer = textoIngresado;


            const categoriaDetectada = clasificarDuda(textoIngresado);

            if (categoriaDetectada) {
              nextStep(categoriaDetectada); // Redirige correctamente
            } else {
              addMessage('Lo siento, no entend√≠ tu consulta. ¬øPuedes intentar reformularla o elegir una opci√≥n de la lista?', 'bot', () => {
                nextStep('consultas');
              });
            }
          });
        });
      },


      sintomas: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øQu√© s√≠ntoma deseas consultar?`, 'bot', () => {
          showOptions(['Dolor de cabeza', 'Fiebre', 'Tos', 'Malestar general'], (respuesta) => {
            guardarRespuesta(userName, 'S√≠ntomas generales', respuesta);
            handleVideo(respuesta); // sigue con tu l√≥gica de mostrar video
          });
        });
      },
      medicamentos: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øC√≥mo debo tomar mi pastilla?', '¬øQu√© hago si olvid√© una dosis?', '¬øPuedo tomar 2 pastillas juntas?', '¬øQu√© medicamentos no debo mezclar?'], (respuesta) => {
            guardarRespuesta(userName, 'Cuidado de medicamentos', respuesta);
            handleVideo(respuesta);
          });
        });
      },
      prevencion: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øC√≥mo puedo evitar un resfriado?', '¬øQu√© hago para cuidar mi salud todos los d√≠as?', '¬øPor qu√© es importante lavarse las manos?', '¬øDebo vacunarme?'], (respuesta) => {
            guardarRespuesta(userName, 'Prevenci√≥n', respuesta);
            handleVideo(respuesta);
          });
        });
      },
      emergencias: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øQu√© hago si alguien se desmaya?', '¬øC√≥mo actuar ante una convulsi√≥n?', '¬øQu√© hacer si hay dificultad para respirar?', '¬øCu√°ndo debo ir a emergencias?'], (respuesta) => {
            guardarRespuesta(userName, 'Emergencias', respuesta);
            handleVideo(respuesta);
          });
        });
      }
    };

    function addMessage(content, sender = 'bot', callback) {
      const wrapper = document.createElement('div');
      wrapper.className = `chat-message ${sender}`;

      const card = document.createElement('div');
      card.className = 'card-mensaje';
      // Si el emisor es el bot, a√±adir imagen de doctor
      if (sender === 'bot') {
        const icon = document.createElement('img');
        icon.src = 'static/img/icono-doctor.png'; // ‚Üê reemplaza con la ruta correcta
        icon.alt = 'Doctor';
        icon.className = 'icono-bot';     // ‚Üê se puede usar para estilo CSS
        wrapper.appendChild(icon);
      }
      if (typeof content === 'string') {
        card.textContent = content;
      } else {
        card.appendChild(content); // ‚Üê bot√≥n HTML
      }

      wrapper.appendChild(card);
      chatContainer.appendChild(wrapper);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (callback) setTimeout(callback, 400);
    }



    function showOptions(options, callback) {
      const btnGroup = document.createElement('div');
      btnGroup.className = 'chat-buttons';

      options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = 'chat-button-option';
        const icon = document.createElement('i');
        icon.className = `bi ${iconMap[opt] || 'bi-chat-text'}`;
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode(opt));

        // Agregar el color de fondo seg√∫n el orden
        btn.style.backgroundColor = getComputedStyle(document.documentElement)
          .getPropertyValue(`--button${index + 1}`).trim();

        btn.onclick = () => {
          if (btnGroup.parentNode) btnGroup.remove();
          lastUserAnswer = opt;


          // Clonar el bot√≥n y enviarlo como mensaje
          const clonedBtn = btn.cloneNode(true);
          addMessage(clonedBtn, 'user'); // ‚Üê pasar como elemento, no texto
          callback(opt);
        };

        btnGroup.appendChild(btn);
      });

      chatContainer.appendChild(btnGroup);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function clasificarDuda(texto) {
      const textoLower = texto.toLowerCase();

      if (
        textoLower.includes('dolor') || textoLower.includes('fiebre') || textoLower.includes('tos') ||
        textoLower.includes('malestar') || textoLower.includes('mareo') || textoLower.includes('n√°usea') ||
        textoLower.includes('cansancio') || textoLower.includes('v√≥mito') || textoLower.includes('resfr√≠o') ||
        textoLower.includes('escalofr√≠os') || textoLower.includes('s√≠ntoma') || textoLower.includes('congesti√≥n')
      ) {
        return 'sintomas';
      } else if (
        textoLower.includes('pastilla') || textoLower.includes('dosis') || textoLower.includes('medicamento') ||
        textoLower.includes('medicaci√≥n') || textoLower.includes('tomar') || textoLower.includes('receta') ||
        textoLower.includes('tratamiento') || textoLower.includes('jarabe') || textoLower.includes('inyectar') ||
        textoLower.includes('inyecci√≥n') || textoLower.includes('efectos secundarios')
      ) {
        return 'medicamentos';
      } else if (
        textoLower.includes('prevenir') || textoLower.includes('evitar') || textoLower.includes('vacunar') ||
        textoLower.includes('lavarse') || textoLower.includes('higiene') || textoLower.includes('cuidados') ||
        textoLower.includes('proteger') || textoLower.includes('alimentaci√≥n') || textoLower.includes('saludable') ||
        textoLower.includes('prevenci√≥n') || textoLower.includes('infecci√≥n')
      ) {
        return 'prevencion';
      } else if (
        textoLower.includes('emergencia') || textoLower.includes('convulsi√≥n') || textoLower.includes('desmaya') ||
        textoLower.includes('respirar') || textoLower.includes('urgencia') || textoLower.includes('accidente') ||
        textoLower.includes('sangrado') || textoLower.includes('fractura') || textoLower.includes('paro') ||
        textoLower.includes('intoxicaci√≥n') || textoLower.includes('quemadura') || textoLower.includes('ahogo')
      ) {
        return 'emergencias';
      }

      return null; // Si no reconoce nada
    }


    function handleVideo(opcion) {
      lastUserAnswer = opcion;

      // Obtener el video correspondiente a la opci√≥n
      const videoSrc = videoMap[opcion] || 'https://www.w3schools.com/html/mov_bbb.mp4'; // Video por defecto si no se encuentra

      addMessage(`Has seleccionado "${opcion}". A continuaci√≥n, te mostrar√© un video en Lengua de Se√±as Peruana donde se explica qu√© debes saber.`, 'bot', () => {
        const video = document.createElement('video');
        video.src = videoSrc;
        video.controls = true;
        video.style.width = '100%';

        // Insertar el video como mensaje del bot (mantiene estilo)
        addMessage(video, 'bot', () => {
          // Luego del video, preguntar satisfacci√≥n
          preguntarSatisfaccion(() => {
            // Y luego mostrar botones finales
            mostrarBotonesFinal();
          });
        });
      });
    }
    function showInputText(callback) {
      const container = document.createElement('div');
      const input = document.createElement('textarea');
      input.placeholder = 'Escribe tu duda aqu√≠...';
      input.className = 'form-control';
      input.rows = 3;

      const button = document.createElement('button');
      button.textContent = 'Enviar';
      button.className = 'btn btn-success mt-2';
      button.onclick = () => {
        const texto = input.value.trim();
        if (texto) {
          addMessage(texto, 'user');
          container.remove();
          callback(texto);
        }
      };

      container.appendChild(input);
      container.appendChild(button);
      document.getElementById('chat').appendChild(container);
    }

    function mostrarBotonesFinal() {
      const finalBtns = document.createElement('div');
      finalBtns.className = 'chat-buttons mt-2';

      const otraConsulta = document.createElement('button');
      otraConsulta.innerHTML = '<i class="bi bi-arrow-repeat"></i> Otra consulta';
      otraConsulta.onclick = () => {
        finalBtns.remove();
        addMessage('Consulta anterior: ' + lastUserAnswer, 'bot');
        nextStep('consultas');
      };

      const finalizar = document.createElement('button');
      finalizar.innerHTML = '<i class="bi bi-door-closed"></i> Finalizar consulta';
      finalizar.onclick = () => {
        finalBtns.remove();
        addMessage('Gracias por usar Telemedic. ¬°Cuida tu salud! üíú', 'bot');
      };

      finalBtns.appendChild(otraConsulta);
      finalBtns.appendChild(finalizar);
      chatContainer.appendChild(finalBtns);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    function nextStep(step) {
      currentStep = step;
      steps[step]();
    }

    function preguntarSatisfaccion(callbackFinal) {
      const opciones = ['Muy satisfecho', 'Satisfecho', 'Poco Satisfecho', 'Nada Satisfecho'];

      addMessage("¬øQu√© tan satisfecho est√°s con la ayuda mostrada?", 'bot', () => {
        showOptions(opciones, (respuestaSatisfaccion) => {
          guardarSatisfaccion(userName, respuestaSatisfaccion);
          callbackFinal(); // Continuar con botones finales
        });
      });
    }


    function guardarRespuesta(nombre, opcion, decision) {
      fetch('/guardar_respuesta', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nombre: nombre,
          opcion: opcion,
          decision: decision
        })
      })
        .then(response => {
          if (response.ok) {
            console.log("Respuesta guardada correctamente");
          } else {
            console.error("Error al guardar la respuesta");
          }
        })
        .catch(error => console.error("Error en fetch:", error));
    }
    function guardarSatisfaccion(nombre, satisfaccion) {
      fetch('/guardar_satisfaccion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nombre: nombre,
          satisfaccion: satisfaccion
        })
      })
        .then(response => {
          if (response.ok) {
            console.log("Satisfacci√≥n guardada correctamente");
          } else {
            console.error("Error al guardar satisfacci√≥n");
          }
        })
        .catch(error => console.error("Error en fetch de satisfacci√≥n:", error));
    }


    window.onload = () => {
      steps[currentStep]();
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>