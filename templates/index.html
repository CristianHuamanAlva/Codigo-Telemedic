<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Telemedic | Asistente Virtual</title>

  <!-- Bootstrap y Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/index.css">

</head>

<body class="d-flex flex-column min-vh-100">

  <!-- NAVBAR (arriba del todo) -->
  {% if current_user.is_authenticated %}
  <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
    <span class="navbar-brand">Telemedic</span>
    <div class="user-info d-flex align-items-center gap-2 position-relative">
      <span class="user-welcome">Bienvenido, {{ current_user.nombre }}</span>
      <div class="dropdown">
        <button class="btn btn-icon dropdown-toggle p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle fs-4 text-white"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end custom-dropdown">
          <li><a class="dropdown-item logout-item" href="/logout">Cerrar sesi√≥n</a></li>
        </ul>
      </div>
    </div>
  </nav>
  {% else %}
  <nav class="navbar navbar-custom d-flex justify-content-between align-items-center">
    <span class="navbar-brand">Telemedic</span>
    <a href="/login" class="btn btn-light fw-semibold">Iniciar sesi√≥n</a>
  </nav>
  {% endif %}

  <!-- CONTENIDO PRINCIPAL: Sidebar + Chat -->
  <div class="d-flex flex-grow-1 position-relative">
    {% if current_user.is_authenticated %}
    <!-- SIDEBAR -->
    <div id="sidebar" class="sidebar bg-light p-3">
      <div class="sidebar-header d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Historial</h5>
      </div>
      <ul id="historial-lista" class="list-unstyled"></ul>
    </div>

    <!-- BOT√ìN TOGGLE flotante -->
    <button id="toggleSidebar" class="toggle-sidebar-button" title="Ocultar historial">
      <i class="bi bi-chevron-left"></i>
    </button>
    {% endif %}

    <!-- CONTENEDOR PRINCIPAL DEL CHAT -->
    <div id="main-container" class="flex-grow-1 d-flex flex-column">
      <div class="chat-container d-flex flex-column">
        <div id="chat" class="p-3 d-flex flex-column"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER FUERA del contenedor principal para ocupar todo el ancho -->
  <footer class="custom-footer text-center text-white py-3 mt-0">
    <div class="container">
      <p class="mb-1">¬© 2025 <strong>Telemedic</strong>. Todos los derechos reservados.</p>
      <p class="mb-1">Elaborado por <strong>Grupo 5</strong> ‚Äì Estudiantes del curso de <em>Dise√±o de Productos y
          Servicios</em>.</p>
      <p class="mb-0">Versi√≥n 1.0 | Asistente virtual para orientaci√≥n m√©dica accesible</p>
    </div>
  </footer>

  <script>
    const userName = "{{ current_user.nombre }}";
    const chatContainer = document.getElementById('chat');

    let currentStep = 'start';
    let lastUserAnswer = null;

    let historialChat = [];

    const iconMap = {
      'S√≠ntomas generales': 'bi-thermometer-half',
      'Cuidado de medicamentos': 'bi-capsule',
      'Prevenci√≥n': 'bi-shield-check',
      'Emergencias': 'bi-exclamation-triangle',
      'Dolor de cabeza': 'bi-emoji-dizzy',
      'Fiebre': 'bi-thermometer-sun',
      'Tos': 'bi-wind',
      'Malestar general': 'bi-emoji-neutral',
    };
    const videoMap = {
      // S√≠ntomas generales
      'Dolor de cabeza': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1751995308/dolor_de_cabeza_tg4d39.mp4',// 'videos/dolor_cabeza.mp4',
      'Fiebre': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1751995469/fiebre_ymp5cq.mp4',
      'Tos': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1751995572/tos_vcjtuw.mp4',
      'Malestar general': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1751995533/malestar_general_uli0zs.mp4',

      // Cuidado de medicamentos
      '¬øC√≥mo debo tomar mi pastilla?': 'https://samplelib.com/lib/preview/mp4/sample-20s.mp4',
      '¬øQu√© hago si olvid√© una dosis?': 'https://samplelib.com/lib/preview/mp4/sample-30s.mp4',
      '¬øPuedo tomar 2 pastillas juntas?': 'https://samplelib.com/lib/preview/mp4/sample-40s.mp4',
      '¬øQu√© medicamentos no debo mezclar?': 'https://samplelib.com/lib/preview/mp4/sample-50s.mp4',

      // Prevenci√≥n
      '¬øC√≥mo puedo evitar un resfriado?': 'https://samplelib.com/lib/preview/mp4/sample-1mb.mp4',
      '¬øQu√© hago para cuidar mi salud todos los d√≠as?': '/static/videos/prevenir.mp4',
      '¬øPor qu√© es importante lavarse las manos?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020311/porque-es-importante-lavarse-las-manos_wpssw2.mp4',
      '¬øDebo vacunarme?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020314/debo-vacunarme_uy2ntb.mp4',

      // Emergencias
      '¬øQu√© hago si alguien se desmaya?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020321/que-hago-si-alguien-se-desmaya_uxtzcw.mp4',
      '¬øC√≥mo actuar ante una convulsi√≥n?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020309/como-actuar-ante-una-convulsion_bbxnaz.mp4',
      '¬øQu√© hacer si hay dificultad para respirar?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020312/que-hacer-si-hay-dificultad-para-respirar_wnahd3.mp4',
      '¬øCu√°ndo debo ir a emergencias?': 'https://res.cloudinary.com/dwacjvsdx/video/upload/v1752020309/cuando-debo-ir-a-emergencias_lxdpnf.mp4'
    };

    const preguntasFrecuentes = [
      {
        pregunta: "¬øQu√© es Telemedic?",
        respuesta: "Es un asistente virtual accesible que orienta en temas m√©dicos usando videos en Lengua de Se√±as Peruana."
      },
      {
        pregunta: "¬øC√≥mo funciona?",
        respuesta: "Seleccionas un tema de salud, eliges una duda o escribes la tuya y el sistema te muestra orientaci√≥n en video."
      },
      {
        pregunta: "¬øPuedo hacer otra consulta?",
        respuesta: "S√≠, al final de cada video puedes elegir 'Otra consulta' para comenzar nuevamente."
      },
      {
        pregunta: "¬øQu√© pasa si no entiendo la respuesta?",
        respuesta: "Podras leer la transcripci√≥n del video para poder entender mejor que hacer en esas situaciones."
      }
    ];
    // Se crean las constanstes de las transcripciones del video
    const transcripciones = {
      // S√≠ntomas generales
      'Dolor de cabeza': 'El dolor de cabeza puede tener muchas causas. Para aliviarlo, descansa, mantente hidratado y evita ruidos fuertes. Si persiste, consulta a un m√©dico.',
      'Fiebre': 'La fiebre es una se√±al de que el cuerpo est√° combatiendo una infecci√≥n. Mantente hidratado, usa ropa ligera y consulta si supera los 39¬∞C.',
      'Tos': 'La tos ayuda a limpiar las v√≠as respiratorias. Toma l√≠quidos tibios, evita el polvo y consulta si dura m√°s de una semana.',
      'Malestar general': 'El malestar general puede indicar una gripe o fatiga. Descansa, alim√©ntate bien y si empeora, busca atenci√≥n m√©dica.',

      // Cuidado de medicamentos
      '¬øC√≥mo debo tomar mi pastilla?': 'Sigue siempre las indicaciones del m√©dico o del envase. T√≥mala con agua y a la misma hora cada d√≠a si es posible.',
      '¬øQu√© hago si olvid√© una dosis?': 'T√≥mala apenas lo recuerdes, pero si falta poco para la siguiente dosis, s√°ltala. No tomes doble dosis.',
      '¬øPuedo tomar 2 pastillas juntas?': 'Solo si el m√©dico lo indica. Tomar m√°s de lo recetado puede ser peligroso.',
      '¬øQu√© medicamentos no debo mezclar?': 'Algunos medicamentos pueden causar efectos negativos si se combinan. Consulta siempre antes de mezclar pastillas.',

      // Prevenci√≥n
      '¬øC√≥mo puedo evitar un resfriado?': 'L√°vate las manos con frecuencia, evita el contacto cercano con personas enfermas y mant√©n una buena alimentaci√≥n.',
      '¬øQu√© hago para cuidar mi salud todos los d√≠as?': 'Come balanceado, haz ejercicio, duerme bien y mant√©n una buena higiene personal.',
      '¬øPor qu√© es importante lavarse las manos?': 'Lavarse las manos con agua y jab√≥n elimina g√©rmenes, bacterias y virus que pueden causar enfermedades como gripe, diarrea o COVID. Es una forma muy simple y efectiva de proteger tu salud y la de los dem√°s. Se debe hacer antes de comer, despu√©s de ir al ba√±o y al llegar de la calle. Si no hay agua, se puede usar alcohol en gel. Es un h√°bito peque√±o, pero muy poderoso.',
      '¬øDebo vacunarme?': 'S√≠, vacunarse es muy importante. Las vacunas ense√±an al cuerpo a defenderse contra enfermedades graves como el sarampi√≥n, el t√©tanos o el COVID. Protegen no solo a ti, sino tambi√©n a otras personas, como beb√©s, personas mayores o con enfermedades. Algunas vacunas son obligatorias y otras recomendadas, pero todas ayudan a prevenir contagios. Son seguras, y los efectos secundarios son leves y temporales.',

      // Emergencias
      '¬øQu√© hago si alguien se desmaya?': 'Primero, revisa si respira. Si s√≠, acuesta a la persona boca arriba, eleva sus piernas para que la sangre suba al cerebro y afloja su ropa. Aseg√∫rate de que haya aire. No le des comida ni agua. Si no reacciona en un minuto, llama al 911 o servicio de emergencias. Qu√©date con la persona hasta que despierte o llegue ayuda. Si vomita, col√≥cala de lado para evitar que se ahogue.',
      '¬øC√≥mo actuar ante una convulsi√≥n?': 'Mant√©n la calma. No sujetes a la persona ni pongas nada en su boca. Prot√©gela de objetos cercanos para que no se lastime. Ponla de lado si es posible, y f√≠jate cu√°nto dura la convulsi√≥n. Si pasa de 5 minutos o es la primera vez que ocurre, llama al 911. Cuando termine, qu√©date con la persona. Puede estar confundida o muy cansada. Dale tiempo para recuperarse.',
      '¬øQu√© hacer si hay dificultad para respirar?': 'Ayuda a la persona a sentarse, no recostarse. Afloja su ropa. Si tiene inhalador, d√°selo. Si no mejora en pocos minutos, llama a emergencias. Mientras tanto, tranquil√≠zala. Si la persona se pone azul, se desmaya o deja de respirar, inicia RCP si sabes hacerlo. La dificultad para respirar puede ser por asma, alergias o problemas card√≠acos, as√≠ que act√∫a r√°pido.',
      '¬øCu√°ndo debo ir a emergencias?': 'Ve a emergencias si tienes dolor muy fuerte, sangrado que no para, dificultad para respirar, desmayos, fiebre muy alta, v√≥mitos persistentes o confusi√≥n. Tambi√©n si hay una herida profunda, quemadura grave o un accidente fuerte. No esperes a que empeore. Si no est√°s seguro, es mejor ir y que un m√©dico lo revise. Es mejor prevenir¬†que¬†lamentar.'
    };



    const steps = {
      start: () => {
        addMessage(`¬°Hola ${userName}! Soy Telemedic, tu asistente virtual para orientaci√≥n m√©dica accesibleüßë‚Äç‚öïü§ù ¬øEst√°s listo para comenzar?`, 'bot', () => {
          nextStep('consultas');
        });
      },
      consultas: () => {
        addMessage('¬øEn qu√© tema de salud deseas recibir orientaci√≥n hoy?', 'bot', () => {
          showOptions(['Elegir de una lista', 'Escribir mi duda'], (respuesta) => {
            if (respuesta === 'Elegir de una lista') {
              showOptions(['S√≠ntomas generales', 'Cuidado de medicamentos', 'Prevenci√≥n', 'Emergencias'], (tema) => {
                lastUserAnswer = tema;
                if (tema === 'S√≠ntomas generales') nextStep('sintomas');
                else if (tema === 'Cuidado de medicamentos') nextStep('medicamentos');
                else if (tema === 'Prevenci√≥n') nextStep('prevencion');
                else if (tema === 'Emergencias') nextStep('emergencias');
              });
            } else {
              nextStep('entradaLibre');
            }
          });
        });
      },
      entradaLibre: () => {
        addMessage('Escribe tu duda m√©dica y te responder√© en Lengua de Se√±as Peruana:', 'bot', () => {
          showInputText((textoIngresado) => {
            lastUserAnswer = textoIngresado;


            const categoriaDetectada = clasificarDuda(textoIngresado);

            if (categoriaDetectada) {
              nextStep(categoriaDetectada); // Redirige correctamente
            } else {
              addMessage('Lo siento, no entend√≠ tu consulta. ¬øPuedes intentar reformularla o elegir una opci√≥n de la lista?', 'bot', () => {
                nextStep('consultas');
              });
            }
          });
        });
      },


      sintomas: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øQu√© s√≠ntoma deseas consultar?`, 'bot', () => {
          showOptions(['Dolor de cabeza', 'Fiebre', 'Tos', 'Malestar general'], (respuesta) => {
            guardarRespuesta(userName, 'S√≠ntomas generales', respuesta);
            handleVideo(respuesta); // sigue con tu l√≥gica de mostrar video
          });
        });
      },
      medicamentos: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øC√≥mo debo tomar mi pastilla?', '¬øQu√© hago si olvid√© una dosis?', '¬øPuedo tomar 2 pastillas juntas?', '¬øQu√© medicamentos no debo mezclar?'], (respuesta) => {
            guardarRespuesta(userName, 'Cuidado de medicamentos', respuesta);
            handleVideo(respuesta);
          });
        });
      },
      prevencion: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øC√≥mo puedo evitar un resfriado?', '¬øQu√© hago para cuidar mi salud todos los d√≠as?', '¬øPor qu√© es importante lavarse las manos?', '¬øDebo vacunarme?'], (respuesta) => {
            guardarRespuesta(userName, 'Prevenci√≥n', respuesta);
            handleVideo(respuesta);
          });
        });
      },
      emergencias: () => {
        addMessage(`Has seleccionado "${lastUserAnswer}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {
          showOptions(['¬øQu√© hago si alguien se desmaya?', '¬øC√≥mo actuar ante una convulsi√≥n?', '¬øQu√© hacer si hay dificultad para respirar?', '¬øCu√°ndo debo ir a emergencias?'], (respuesta) => {
            guardarRespuesta(userName, 'Emergencias', respuesta);
            handleVideo(respuesta);
          });
        });
      }
    };

    function addMessage(content, sender = 'bot', callback) {
      const wrapper = document.createElement('div');
      wrapper.className = `chat-message ${sender}`;

      const card = document.createElement('div');
      card.className = 'card-mensaje';

      if (sender === 'bot') {
        const icon = document.createElement('img');
        icon.src = 'static/img/icono-doctor.png';
        icon.alt = 'Doctor';
        icon.className = 'icono-bot';
        wrapper.appendChild(icon);
      }

      // üî• MOSTRAR VIDEO desde historial o marcado
      if (typeof content === 'string' && content.startsWith('[VIDEO:')) {
        const clave = content.replace('[VIDEO:', '').replace(']', '').trim();
        const videoSrc = videoMap[clave];

        if (videoSrc) {
          const video = document.createElement('video');
          video.src = videoSrc;
          video.controls = true;
          video.className = 'chat-video'; // Aplica estilo CSS
          card.appendChild(video);
        } else {
          card.textContent = '‚ö†Ô∏è Video no encontrado';
        }

        // üî• Si es string, mostrar como texto
      } else if (typeof content === 'string') {
        card.textContent = content;

        // üî• Si es un nodo HTML como bot√≥n, video, etc.
      } else if (content instanceof HTMLElement) {
        card.appendChild(content);
      }

      wrapper.appendChild(card);
      chatContainer.appendChild(wrapper); // se mantiene igual

      chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: "smooth"
      });


      if (callback) setTimeout(callback, 400);
    }


    function showOptions(options, callback) {
      const btnGroup = document.createElement('div');
      btnGroup.className = 'chat-buttons';

      options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = 'chat-button-option';
        btn.dataset.button = index + 1; // üëà GUARDAR n√∫mero del bot√≥n

        const icon = document.createElement('i');
        icon.className = `bi ${iconMap[opt] || 'bi-chat-text'}`;
        btn.appendChild(icon);
        btn.appendChild(document.createTextNode(` ${opt}`));

        // Asignar color usando la variable CSS
        const bgColor = getComputedStyle(document.documentElement)
          .getPropertyValue(`--button${index + 1}`).trim();
        btn.style.backgroundColor = bgColor;

        btn.onclick = () => {
          if (btnGroup.parentNode) btnGroup.remove();
          lastUserAnswer = opt;

          // Crear bot√≥n de usuario con MISMO n√∫mero
          const userBtn = document.createElement('button');
          userBtn.className = btn.className;
          userBtn.innerHTML = btn.innerHTML;
          userBtn.disabled = true;

          const buttonNumber = btn.dataset.button; // üëà recuperar el n√∫mero
          const finalBgColor = getComputedStyle(document.documentElement)
            .getPropertyValue(`--button${buttonNumber}`).trim();
          userBtn.style.backgroundColor = finalBgColor;

          // Copiar otros estilos visuales
          const computedStyle = getComputedStyle(btn);
          userBtn.style.color = '#000'; // üëà Esto forza el texto negro
          userBtn.style.fontWeight = computedStyle.fontWeight;
          userBtn.style.borderRadius = computedStyle.borderRadius;
          userBtn.style.boxShadow = computedStyle.boxShadow;
          userBtn.style.padding = computedStyle.padding;
          userBtn.style.fontFamily = computedStyle.fontFamily;

          addMessage(userBtn, 'user');
          callback(opt);
        };

        btnGroup.appendChild(btn);
      });


      chatContainer.appendChild(btnGroup);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function clasificarDuda(texto) {
      const textoLower = texto.toLowerCase();

      if (
        textoLower.includes('dolor') || textoLower.includes('fiebre') || textoLower.includes('tos') ||
        textoLower.includes('malestar') || textoLower.includes('mareo') || textoLower.includes('n√°usea') ||
        textoLower.includes('cansancio') || textoLower.includes('v√≥mito') || textoLower.includes('resfr√≠o') ||
        textoLower.includes('escalofr√≠os') || textoLower.includes('s√≠ntoma') || textoLower.includes('congesti√≥n')
      ) {
        return 'sintomas';
      } else if (
        textoLower.includes('pastilla') || textoLower.includes('dosis') || textoLower.includes('medicamento') ||
        textoLower.includes('medicaci√≥n') || textoLower.includes('tomar') || textoLower.includes('receta') ||
        textoLower.includes('tratamiento') || textoLower.includes('jarabe') || textoLower.includes('inyectar') ||
        textoLower.includes('inyecci√≥n') || textoLower.includes('efectos secundarios')
      ) {
        return 'medicamentos';
      } else if (
        textoLower.includes('prevenir') || textoLower.includes('evitar') || textoLower.includes('vacunar') ||
        textoLower.includes('lavarse') || textoLower.includes('higiene') || textoLower.includes('cuidados') ||
        textoLower.includes('proteger') || textoLower.includes('alimentaci√≥n') || textoLower.includes('saludable') ||
        textoLower.includes('prevenci√≥n') || textoLower.includes('infecci√≥n')
      ) {
        return 'prevencion';
      } else if (
        textoLower.includes('emergencia') || textoLower.includes('convulsi√≥n') || textoLower.includes('desmaya') ||
        textoLower.includes('respirar') || textoLower.includes('urgencia') || textoLower.includes('accidente') ||
        textoLower.includes('sangrado') || textoLower.includes('fractura') || textoLower.includes('paro') ||
        textoLower.includes('intoxicaci√≥n') || textoLower.includes('quemadura') || textoLower.includes('ahogo')
      ) {
        return 'emergencias';
      }

      return null; // Si no reconoce nada
    }
    function cargarHistorial() {
      fetch('/historial_respuestas')
        .then(res => res.json())
        .then(data => {
          const lista = document.getElementById('historial-lista');
          lista.innerHTML = '';
          // Bot√≥n Preguntas frecuentes
          const faqBtn = document.createElement('button');
          faqBtn.textContent = 'Preguntas frecuentes';
          faqBtn.className = 'btn btn-outline-success w-100 mb-2 fw-semibold';
          faqBtn.onclick = mostrarFAQ;
          lista.appendChild(faqBtn);

          // Bot√≥n "Nuevo chat"
          const nuevoChatBtn = document.createElement('button');
          nuevoChatBtn.textContent = 'üÜï Nuevo chat';
          nuevoChatBtn.className = 'btn btn-success w-100 mb-3 fw-semibold';
          nuevoChatBtn.onclick = () => {
            chatContainer.innerHTML = '';
            currentStep = 'start';
            steps['start']();
          };
          lista.appendChild(nuevoChatBtn);

          data.forEach((item, i) => {
            const li = document.createElement('li');
            li.className = 'mb-2';

            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-primary w-100 text-start fw-semibold';
            btn.innerHTML = `<strong>${item.titulo}: ${item.opcion}</strong>`;

            btn.onclick = () => {
              fetch(`/obtener_historial/${item.id}`)
                .then(res => res.json())
                .then(historial => {
                  renderConversacion(historial, item, i);  // üëà Pasamos el √≠ndice tambi√©n
                });
            };

            li.appendChild(btn);
            lista.appendChild(li);
          });
        });
    }

    function renderConversacion(historial, item, indexGlobal) {
      document.getElementById('chat').innerHTML = '';

      const decisionColorMap = {
        'Dolor de cabeza': '--button1',
        'Fiebre': '--button2',
        'Tos': '--button3',
        'Malestar general': '--button4',

        '¬øC√≥mo debo tomar mi pastilla?': '--button1',
        '¬øQu√© hago si olvid√© una dosis?': '--button2',
        '¬øPuedo tomar 2 pastillas juntas?': '--button3',
        '¬øQu√© medicamentos no debo mezclar?': '--button4',

        '¬øC√≥mo puedo evitar un resfriado?': '--button1',
        '¬øQu√© hago para cuidar mi salud todos los d√≠as?': '--button2',
        '¬øPor qu√© es importante lavarse las manos?': '--button3',
        '¬øDebo vacunarme?': '--button4',

        '¬øQu√© hago si alguien se desmaya?': '--button1',
        '¬øC√≥mo actuar ante una convulsi√≥n?': '--button2',
        '¬øQu√© hacer si hay dificultad para respirar?': '--button3',
        '¬øCu√°ndo debo ir a emergencias?': '--button4',

        'Muy satisfecho': '--button1',
        'Satisfecho': '--button2',
        'Poco Satisfecho': '--button3',
        'Nada Satisfecho': '--button4'

      };

      const iconMap = {
        'Dolor de cabeza': 'bi-emoji-dizzy',
        'Fiebre': 'bi-thermometer-sun',
        'Tos': 'bi-wind',
        'Malestar general': 'bi-emoji-neutral',

        'S√≠ntomas generales': 'bi-thermometer-half',
        'Cuidado de medicamentos': 'bi-capsule',
        'Prevenci√≥n': 'bi-shield-check',
        'Emergencias': 'bi-exclamation-triangle',

        // Satisfacci√≥n
        'Muy satisfecho': 'bi-emoji-heart-eyes',
        'Satisfecho': 'bi-emoji-smile',
        'Poco Satisfecho': 'bi-emoji-neutral',
        'Nada Satisfecho': 'bi-emoji-frown'
      };

      const temaColorMap = {
        'S√≠ntomas generales': '--button1',
        'Cuidado de medicamentos': '--button2',
        'Prevenci√≥n': '--button3',
        'Emergencias': '--button4'
      };

      const colorVarTema = temaColorMap[item.opcion] || '--button1';
      const colorTema = getComputedStyle(document.documentElement)
        .getPropertyValue(colorVarTema).trim();

      const decisionColorVar = decisionColorMap[item.decision] || '--button5';
      const colorDecision = getComputedStyle(document.documentElement)
        .getPropertyValue(decisionColorVar).trim();

      const colorSatisfaccion = getComputedStyle(document.documentElement)
        .getPropertyValue('--button6').trim();

      addMessage(`¬°Hola ${userName}! Soy Telemedic, tu asistente virtual para orientaci√≥n m√©dica accesibleüßë‚Äç‚öïü§ù ¬øEst√°s listo para comenzar?`, 'bot', () => {
        addMessage("¬øEn qu√© tema de salud deseas recibir orientaci√≥n hoy?", 'bot', () => {

          // BOT√ìN DE TEMA (OPCI√ìN PRINCIPAL)
          const temaBtn = document.createElement('button');
          temaBtn.className = 'chat-button-option';
          temaBtn.disabled = true;

          const temaIcon = document.createElement('i');
          const temaIcono = iconMap.hasOwnProperty(item.opcion) ? iconMap[item.opcion] : 'bi-chat-text';
          temaIcon.className = `bi ${temaIcono}`;

          temaBtn.appendChild(temaIcon);
          temaBtn.appendChild(document.createTextNode(` ${item.opcion}`));

          temaBtn.style.backgroundColor = colorTema;
          temaBtn.style.color = '#000';

          addMessage(temaBtn, 'user', () => {
            addMessage(`Has seleccionado "${item.opcion}". ¬øSobre qu√© deseas consultar?`, 'bot', () => {

              // BOT√ìN DE DECISI√ìN
              const decisionBtn = document.createElement('button');
              decisionBtn.className = 'chat-button-option';
              decisionBtn.disabled = true;

              const decisionIcon = document.createElement('i');
              const decisionIcono = iconMap.hasOwnProperty(item.decision) ? iconMap[item.decision] : 'bi-chat-text';
              decisionIcon.className = `bi ${decisionIcono}`;

              decisionBtn.appendChild(decisionIcon);
              decisionBtn.appendChild(document.createTextNode(` ${item.decision}`));

              decisionBtn.style.backgroundColor = colorDecision;
              decisionBtn.style.color = '#000';

              addMessage(decisionBtn, 'user', () => {
                addMessage(`Has seleccionado "${item.decision}". A continuaci√≥n, te mostrar√© un video en Lengua de Se√±as Peruana donde se explica qu√© debes saber.`, 'bot', () => {

                  const videoMsg = historial.find(m => m.contenido.startsWith("[VIDEO:"));
                  if (videoMsg) {
                    const clave = videoMsg.contenido.replace('[VIDEO:', '').replace(']', '').trim();
                    const videoSrc = videoMap[clave];
                    const video = document.createElement('video');
                    video.src = videoSrc;
                    video.controls = true;
                    video.className = 'chat-video';

                    addMessage(video, 'bot', () => {
                      // Mostrar transcripci√≥n si existe y luego satisfacci√≥n
                      if (transcripciones[item.decision]) {
                        const transcripcionBox = document.createElement('div');
                        transcripcionBox.className = 'transcripcion-box mt-2 p-3 rounded text-dark';
                        transcripcionBox.innerHTML = `<strong>üìù Transcripci√≥n del video:</strong><br>${transcripciones[item.decision]}`;
                        addMessage(transcripcionBox, 'bot', () => {
                          mostrarSatisfaccionFinal(item, iconMap, decisionColorMap);
                        });
                      } else {
                        mostrarSatisfaccionFinal(item, iconMap, decisionColorMap);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      });
    }
    function mostrarSatisfaccionFinal(item, iconMap, decisionColorMap) {
      if (item.satisfaccion && item.satisfaccion.trim() !== "") {
        const satisfaccionTexto = item.satisfaccion;

        const satisfaccionBtn = document.createElement('button');
        satisfaccionBtn.className = 'chat-button-option';
        satisfaccionBtn.disabled = true;

        const iconoSatisfaccion = iconMap.hasOwnProperty(satisfaccionTexto) ? iconMap[satisfaccionTexto] : 'bi-chat-text';
        const satisfaccionIcon = document.createElement('i');
        satisfaccionIcon.className = `bi ${iconoSatisfaccion}`;

        satisfaccionBtn.appendChild(satisfaccionIcon);
        satisfaccionBtn.appendChild(document.createTextNode(` ${satisfaccionTexto}`));

        const colorVarSatisfaccion = decisionColorMap[item.satisfaccion] || '--button6';
        satisfaccionBtn.style.backgroundColor = getComputedStyle(document.documentElement)
          .getPropertyValue(colorVarSatisfaccion).trim();

        satisfaccionBtn.style.color = '#000';

        addMessage("¬øQu√© tan satisfecho est√°s con la ayuda mostrada?", 'bot', () => {
          addMessage(satisfaccionBtn, 'user');
          addMessage("Gracias por usar Telemedic. ¬°Cuida tu salud! üíú", 'bot');
        });
      }
    }

    function handleVideo(opcion) {
      lastUserAnswer = opcion;

      // Obtener el video correspondiente a la opci√≥n
      const videoSrc = videoMap[opcion] || 'https://www.w3schools.com/html/mov_bbb.mp4'; // Video por defecto si no se encuentra

      // Mostrar mensaje de texto indicando que se va a mostrar el video
      addMessage(`Has seleccionado "${opcion}". A continuaci√≥n, te mostrar√© un video en Lengua de Se√±as Peruana donde se explica qu√© debes saber.`, 'bot', () => {

        // Crear el elemento de video
        const video = document.createElement('video');
        video.src = videoSrc;
        video.controls = true;
        video.style.width = '100%';

        // Mostrar texto representativo del video (para el historial)
        addMessage(`üé• Video explicativo: ${opcion}`, 'bot', () => {
          addMessage(video, 'bot', () => {
            // ‚úÖ Mostrar transcripci√≥n si existe
            if (transcripciones[opcion]) {
              const transcripcionBox = document.createElement('div');
              transcripcionBox.className = 'transcripcion-box mt-2 p-3 rounded text-dark';
              transcripcionBox.innerHTML = `<strong>üìù Transcripci√≥n del video:</strong><br>${transcripciones[opcion]}`;
              addMessage(transcripcionBox, 'bot');
            }
            // Luego del video, preguntar satisfacci√≥n
            preguntarSatisfaccion(() => {
              mostrarBotonesFinal();
            });
          });
        });
      });
    }

    function showInputText(callback) {
      const container = document.createElement('div');
      const input = document.createElement('textarea');
      input.placeholder = 'Escribe tu duda aqu√≠...';
      input.className = 'form-control';
      input.rows = 3;

      const button = document.createElement('button');
      button.textContent = 'Enviar';
      button.className = 'btn btn-success mt-2';
      button.onclick = () => {
        const texto = input.value.trim();
        if (texto) {
          addMessage(texto, 'user');
          container.remove();
          callback(texto);
        }
      };

      container.appendChild(input);
      container.appendChild(button);
      document.getElementById('chat').appendChild(container);
    }

    function mostrarBotonesFinal() {
      const finalBtns = document.createElement('div');
      finalBtns.className = 'chat-buttons mt-2';

      const otraConsulta = document.createElement('button');
      otraConsulta.innerHTML = '<i class="bi bi-arrow-repeat"></i> Otra consulta';
      otraConsulta.onclick = () => {
        finalBtns.remove();
        addMessage('Consulta anterior: ' + lastUserAnswer, 'bot');
        nextStep('consultas');
      };

      const finalizar = document.createElement('button');
      finalizar.innerHTML = '<i class="bi bi-door-closed"></i> Finalizar consulta';
      finalizar.onclick = () => {
        finalBtns.remove();
        addMessage('Gracias por usar Telemedic. ¬°Cuida tu salud! üíú', 'bot');
      };

      finalBtns.appendChild(otraConsulta);
      finalBtns.appendChild(finalizar);
      chatContainer.appendChild(finalBtns);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }


    function nextStep(step) {
      currentStep = step;
      steps[step]();
    }

    function preguntarSatisfaccion(callbackFinal) {
      const opciones = ['Muy satisfecho', 'Satisfecho', 'Poco Satisfecho', 'Nada Satisfecho'];

      addMessage("¬øQu√© tan satisfecho est√°s con la ayuda mostrada?", 'bot', () => {
        showOptions(opciones, (respuestaSatisfaccion) => {
          guardarSatisfaccion(userName, respuestaSatisfaccion);
          cargarHistorial();
          callbackFinal(); // Continuar con botones finales
        });
      });
    }

    function guardarRespuesta(nombre, opcion, decision) {
      // Recolectar historial del chat actual
      const mensajes = Array.from(document.querySelectorAll('.chat-message')).map(m => {
        const esBot = m.classList.contains('bot');
        return {
          emisor: esBot ? 'bot' : 'user',
          contenido: m.textContent.trim()
        };
      });

      fetch('/guardar_respuesta', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nombre: nombre,
          opcion: opcion,
          decision: decision,
          historial: mensajes  // üëà Enviamos el historial
        })
      })
        .then(response => {
          if (response.ok) {
            console.log("Respuesta guardada correctamente");
            cargarHistorial();  // üëà Actualiza el panel lateral
          } else {
            console.error("Error al guardar la respuesta");
          }
        })
        .catch(error => console.error("Error en fetch:", error));
    }


    function guardarSatisfaccion(nombre, satisfaccion) {
      fetch('/guardar_satisfaccion', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          nombre: nombre,
          satisfaccion: satisfaccion
        })
      })
        .then(response => {
          if (response.ok) {
            console.log("Satisfacci√≥n guardada correctamente");
          } else {
            console.error("Error al guardar satisfacci√≥n");
          }
        })
        .catch(error => console.error("Error en fetch de satisfacci√≥n:", error));
    }

    function mostrarFAQ() {
      const modalFondo = document.createElement('div');
      modalFondo.className = 'modal-fondo';

      const modalContenido = document.createElement('div');
      modalContenido.className = 'modal-contenido';

      const cerrarBtn = document.createElement('button');
      cerrarBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
      cerrarBtn.className = 'btn btn-danger btn-sm float-end';
      cerrarBtn.onclick = () => modalFondo.remove();

      const titulo = document.createElement('h5');
      titulo.textContent = 'Preguntas Frecuentes';
      titulo.className = 'mb-3';

      modalContenido.appendChild(cerrarBtn);
      modalContenido.appendChild(titulo);

      preguntasFrecuentes.forEach(p => {
        const pregunta = document.createElement('p');
        pregunta.className = 'fw-bold';
        pregunta.textContent = '‚Ä¢ ' + p.pregunta;

        const respuesta = document.createElement('p');
        respuesta.textContent = p.respuesta;

        modalContenido.appendChild(pregunta);
        modalContenido.appendChild(respuesta);
      });

      modalFondo.appendChild(modalContenido);
      document.body.appendChild(modalFondo);
    }


    document.addEventListener("DOMContentLoaded", function () {
      const toggleBtn = document.getElementById("toggleSidebar");
      const sidebar = document.getElementById("sidebar");

      if (toggleBtn && sidebar) {
        toggleBtn.addEventListener("click", function () {
          sidebar.classList.toggle("collapsed");
          const icon = toggleBtn.querySelector("i");

          if (sidebar.classList.contains("collapsed")) {
            icon.classList.remove("bi-chevron-left");
            icon.classList.add("bi-chevron-right");
            toggleBtn.setAttribute("title", "Mostrar historial");
            toggleBtn.style.left = "0px";
          } else {
            icon.classList.remove("bi-chevron-right");
            icon.classList.add("bi-chevron-left");
            toggleBtn.setAttribute("title", "Ocultar historial");
            toggleBtn.style.left = "270px";
          }
        });
      }
    });




    window.onload = () => {
      steps[currentStep]();
      cargarHistorial(); // üëà Carga el historial al iniciar
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>